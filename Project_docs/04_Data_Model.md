# 4. Conceptual Data Model

This document describes the conceptual data model for the system. It focuses on the core entities and their relationships, not a specific database implementation.

## 4.1. Core Entities

### User
Represents an individual who can log in and use the system.
-   `user_id` (Primary Key)
-   `email` (Unique, for login)
-   `hashed_password`
-   `full_name`
-   `role` (e.g., 'admin', 'analyst')

### Reseller
Represents a third-party partner from whom sales data is sourced.
-   `reseller_id` (Primary Key)
-   `name` (e.g., "Selfridges", "Galilu")
-   `country`

### Product
Represents a canonical product that the company sells. Sales data from resellers will be normalized to link to these products.
-   `product_id` (Primary Key)
-   `sku` (Stock Keeping Unit, Unique)
-   `product_name`
-   `product_ean` (European Article Number, used for matching)
-   `functional_name` (Internal product naming)
-   `category`

### OfflineSale (sellout_entries2)
A single offline/wholesale sales transaction record from B2B reseller partners. Typically aggregated monthly data from distributors and retail partners.
-   `sale_id` (Primary Key)
-   `user_id` (Foreign Key to User, for data isolation)
-   `product_id` (Foreign Key to Product)
-   `reseller_id` (Foreign Key to Reseller)
-   `upload_batch_id` (Foreign Key to UploadBatch)
-   `functional_name` (Product name from vendor)
-   `product_ean` (European Article Number, may be NULL)
-   `reseller` (Reseller/distributor name)
-   `sales_eur` (Sales amount in EUR)
-   `quantity` (Quantity sold)
-   `month` (Month number 1-12)
-   `year` (Year e.g., 2024, 2025)
-   `currency` (Original currency code)
-   `created_at` (Timestamp of data import)

### OnlineSale (ecommerce_orders)
A single online/direct-to-consumer sales transaction from the e-commerce platform. Individual order-level data with marketing attribution and geographic details.
-   `order_id` (Primary Key)
-   `user_id` (Foreign Key to User, for data isolation)
-   `product_ean` (European Article Number)
-   `functional_name` (Product name)
-   `product_name` (Display name for product)
-   `order_date` (Date of order)
-   `quantity` (Quantity ordered)
-   `sales_eur` (Sales amount in EUR)
-   `country` (Customer country)
-   `city` (Customer city)
-   `utm_source` (Marketing source, e.g., google, facebook)
-   `utm_medium` (Marketing medium, e.g., cpc, organic)
-   `utm_campaign` (Marketing campaign name)
-   `device_type` (Customer device: mobile, desktop, tablet)
-   `reseller` (Always 'Online' for ecommerce)
-   `cost_of_goods` (Product cost)
-   `stripe_fee` (Payment processing fee)
-   `created_at` (Timestamp of data import)

### UploadBatch
Represents a single file upload event, acting as a container for all sales records derived from that file. This is crucial for data provenance and error tracking.
-   `upload_batch_id` (Primary Key)
-   `uploader_user_id` (Foreign Key to User)
-   `upload_timestamp`
-   `original_filename`
-   `processing_status` (e.g., 'pending', 'completed', 'failed')

### ErrorReport
Stores detailed information about a single error that occurred during the processing of a row in an uploaded file.
-   `error_id` (Primary Key)
-   `upload_batch_id` (Foreign Key to UploadBatch)
-   `row_number_in_file`
-   `error_message` (e.g., "Invalid SKU", "Unparseable date")

### ConversationHistory
Stores AI chat conversation history for memory persistence and context continuity.
-   `conversation_id` (Primary Key)
-   `user_id` (Foreign Key to User)
-   `session_id` (Optional grouping for multiple chat threads)
-   `user_message` (The question asked by user)
-   `ai_response` (The answer generated by AI)
-   `timestamp` (When the exchange occurred)
-   `created_at` (Record creation timestamp)

### DashboardConfig
Stores external dashboard embedding configurations for analytics visualization.
-   `config_id` (Primary Key)
-   `user_id` (Foreign Key to User)
-   `dashboard_name` (User-friendly display name)
-   `dashboard_type` (Platform type: looker, tableau, powerbi, metabase, custom)
-   `dashboard_url` (Embeddable URL for iframe)
-   `authentication_method` (none, bearer_token, api_key, oauth)
-   `authentication_config` (Encrypted credentials/tokens)
-   `permissions` (Array of user IDs or roles allowed to view)
-   `is_active` (Primary dashboard flag)
-   `created_at` (When configuration was created)
-   `updated_at` (When last modified)

### EmailLog
Audit trail for all email notifications and reports sent by the system.
-   `log_id` (Primary Key)
-   `user_id` (Foreign Key to User, recipient)
-   `email_type` (success, failure, scheduled_report)
-   `recipient_email` (Email address)
-   `subject` (Email subject line)
-   `sent_at` (Timestamp of sending)
-   `status` (sent, failed, pending)
-   `error_message` (If failed, reason)
-   `attachment_count` (Number of files attached)
-   `attachment_size` (Total size in bytes)

## 4.2. Entity Relationships

### Core Sales Data
-   A **User** can have many **UploadBatches**.
-   A **User** can have many **OfflineSales** (data isolation).
-   A **User** can have many **OnlineSales** (data isolation).
-   A **Reseller** can be associated with many **OfflineSales**.
-   A **Product** can be associated with many **OfflineSales** and **OnlineSales**.
-   An **UploadBatch** can contain many **OfflineSales** or **OnlineSales**.
-   An **UploadBatch** can have many **ErrorReports** associated with it.

### AI Chat System
-   A **User** can have many **ConversationHistory** records.
-   **ConversationHistory** records are grouped by optional `session_id` for multiple chat threads.

### Dashboard Management
-   A **User** can have many **DashboardConfigs**.
-   Each **DashboardConfig** belongs to exactly one **User**.

### Email System
-   A **User** can have many **EmailLog** entries.
-   Each **EmailLog** records one email sent to a **User**.

## 4.3. Multi-Channel Sales Architecture

The system supports two distinct sales channels with separate data models:

**Offline/Wholesale Channel (sellout_entries2):**
- B2B transactions through reseller partners
- Monthly aggregated data
- Reseller-specific reporting
- Wholesale pricing and volume analysis

**Online Channel (ecommerce_orders):**
- Direct-to-consumer e-commerce
- Individual order-level detail
- Marketing attribution (UTM tracking)
- Geographic and device analysis
- Daily transaction granularity

**Combined Analysis:**
Both channels can be queried together for comprehensive business intelligence, with the AI chat system automatically routing queries to appropriate tables based on user intent.
